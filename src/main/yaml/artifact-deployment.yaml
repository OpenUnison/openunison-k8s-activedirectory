---
apiVersion: v1
data:
  deploy.js: "//    Copyright 2018 Tremolo Security, Inc.\n// \n//    Licensed under\
    \ the Apache License, Version 2.0 (the \"License\");\n//    you may not use this\
    \ file except in compliance with the License.\n//    You may obtain a copy of\
    \ the License at\n// \n//        http://www.apache.org/licenses/LICENSE-2.0\n\
    // \n//    Unless required by applicable law or agreed to in writing, software\n\
    //    distributed under the License is distributed on an \"AS IS\" BASIS,\n//\
    \    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n\
    //    See the License for the specific language governing permissions and\n//\
    \    limitations under the License.\n\n\ninProp['K8S_DB_SECRET'] = java.util.UUID.randomUUID().toString();\n\
    \nprint(\"Loading CertUtils\");\nvar CertUtils = Java.type(\"com.tremolosecurity.kubernetes.artifacts.util.CertUtils\"\
    );\n\nprint(\"Creating openunison keystore\");\n\nksPassword = inProp['unisonKeystorePassword'];\n\
    ouKs = Java.type(\"java.security.KeyStore\").getInstance(\"PKCS12\");\nouKs.load(null,ksPassword.toCharArray());\n\
    \nuse_k8s_cm = inProp['USE_K8S_CM'] == \"true\";\n\nprint(\"Generating client\
    \ certificate for activemq\");\namqCertInfo = {\n    \"serverName\":\"amq-client\"\
    ,\n    \"ou\":\"kubernetes\",\n    \"o\":\"tremolo\",\n    \"l\":\"cloud\",\n\
    \    \"st\":\"cncf\",\n    \"c\":\"ea\",\n    \"caCert\":false\n}\n\nvar amqClientx509data\
    \ = CertUtils.createCertificate(amqCertInfo);\n\nCertUtils.saveX509ToKeystore(ouKs,ksPassword,\"\
    amq-client\",amqClientx509data);\n\nprint(\"generate the amq keystore\");\n\n\
    amqKS = Java.type(\"java.security.KeyStore\").getInstance(\"PKCS12\");\namqKS.load(null,ksPassword.toCharArray());\n\
    \nprint(\"trusting the amq client cert\");\namqKS.setCertificateEntry('trusted-amq-client',ouKs.getCertificate('amq-client'));\n\
    \nprint(\"generating the server side certificate\");\n\namqSrvCertInfo = {\n \
    \ \"serverName\":\"amq.openunison.svc.cluster.local\",\n  \"ou\":\"kubernetes\"\
    ,\n  \"o\":\"tremolo\",\n  \"l\":\"cloud\",\n  \"st\":\"cncf\",\n  \"c\":\"ea\"\
    ,\n  \"caCert\":false\n}\n\nvar amqSrvx509data = CertUtils.createCertificate(amqSrvCertInfo);\n\
    \nif (use_k8s_cm) {\n  print(\"create csr for activemq\");\n\n  amqCsrReq = {\n\
    \    \"apiVersion\": \"certificates.k8s.io/v1beta1\",\n    \"kind\": \"CertificateSigningRequest\"\
    ,\n    \"metadata\": {\n      \"name\": \"amq.openunison.svc.cluster.local\",\n\
    \    },\n    \"spec\": {\n      \"request\": java.util.Base64.getEncoder().encodeToString(CertUtils.generateCSR(amqSrvx509data).getBytes(\"\
    utf-8\")),\n      \"usages\": [\n        \"digital signature\",\n        \"key\
    \ encipherment\",\n        \"server auth\"\n      ]\n    }\n  };\n\n  print(\"\
    Requesting amq certificate\");\n  apiResp = k8s.postWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests',JSON.stringify(amqCsrReq));\n\
    \n\n\n  if (apiResp.code == 409) {\n    print(\"CertManager is not enabled on\
    \ this cluster.  Change USE_K8S_CM=false in your input.props\");\n    exit(1);\n\
    \  }\n\n  print(\"Approving amq certificate\");\n  approveReq = JSON.parse(apiResp.data);\n\
    \  approveReq.status.conditions = [\n    {\n        \"type\":\"Approved\",\n \
    \       \"reason\":\"OpenUnison Deployment\",\n        \"message\":\"This CSR\
    \ was approved by the OpenUnison artifact deployment job\"\n    }\n  ];\n\n  apiResp\
    \ = k8s.putWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests/amq.openunison.svc.cluster.local/approval',JSON.stringify(approveReq));\n\
    \  print(\"Retrieving amq certificate from API server\");\n  apiResp = k8s.callWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests/amq.openunison.svc.cluster.local');\n\
    \  print(apiResp.data);\n  certResp = JSON.parse(apiResp.data);\n  b64cert = certResp.status.certificate;\n\
    \n  if (b64cert == null || b64cert === \"\") {\n    print(\"CertManager is not\
    \ enabled on this cluster.  Change USE_K8S_CM=false in your input.props\");\n\
    \    exit(1);\n  }\n\n\n  CertUtils.importSignedCert(amqSrvx509data,b64cert);\n\
    } else {\n  //not using CM, so store the amq cert directly into the openunison\
    \ keystore\n  ouKs.setCertificateEntry('trusted-amq-server',amqSrvx509data.getCertificate());\n\
    }\n\nprint(\"Saving amq certificate to amq keystore\");\nCertUtils.saveX509ToKeystore(amqKS,ksPassword,\"\
    broker\",amqSrvx509data);\n\n\n\n\n\n\n\nprint(\"Generating openunison tls certificate\"\
    );\ncertInfo = {\n    \"serverName\":\"openunison.openunison.svc.cluster.local\"\
    ,\n    \"ou\":\"kubernetes\",\n    \"o\":\"tremolo\",\n    \"l\":\"cloud\",\n\
    \    \"st\":\"cncf\",\n    \"c\":\"ea\",\n    \"caCert\":false\n}\n\nvar x509data\
    \ = CertUtils.createCertificate(certInfo);\n\nif (use_k8s_cm) {\n  print(\"Creating\
    \ CSR for API server\");\n\n\n\n  csrReq = {\n      \"apiVersion\": \"certificates.k8s.io/v1beta1\"\
    ,\n      \"kind\": \"CertificateSigningRequest\",\n      \"metadata\": {\n   \
    \     \"name\": \"openunison.openunison.svc.cluster.local\",\n      },\n     \
    \ \"spec\": {\n        \"request\": java.util.Base64.getEncoder().encodeToString(CertUtils.generateCSR(x509data).getBytes(\"\
    utf-8\")),\n        \"usages\": [\n          \"digital signature\",\n        \
    \  \"key encipherment\",\n          \"server auth\"\n        ]\n      }\n    };\n\
    \n  print(\"Requesting certificate\");\n  apiResp = k8s.postWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests',JSON.stringify(csrReq));\n\
    \n  print(\"Approving certificate\");\n  approveReq = JSON.parse(apiResp.data);\n\
    \  approveReq.status.conditions = [\n      {\n          \"type\":\"Approved\"\
    ,\n          \"reason\":\"OpenUnison Deployment\",\n          \"message\":\"This\
    \ CSR was approved by the OpenUnison artifact deployment job\"\n      }\n  ];\n\
    \n  apiResp = k8s.putWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests/openunison.openunison.svc.cluster.local/approval',JSON.stringify(approveReq));\n\
    \  print(\"Retrieving certificate from API server\");\n  apiResp = k8s.callWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests/openunison.openunison.svc.cluster.local','java.util.Base64.getDecoder().decode(JSON.parse(ws_response_json).status.certificate);check_ws_response=true;',10);\n\
    \  print(apiResp.data);\n  certResp = JSON.parse(apiResp.data);\n  b64cert = certResp.status.certificate;\n\
    \  CertUtils.importSignedCert(x509data,b64cert);\n}\n\nprint(\"Saving certificate\
    \ to keystore\");\nCertUtils.saveX509ToKeystore(ouKs,ksPassword,\"unison-tls\"\
    ,x509data);\nCertUtils.createKey(ouKs,\"session-unison\",ksPassword);\nCertUtils.createKey(ouKs,\"\
    lastmile-oidc\",ksPassword);\n\nprint(\"Generating OIDC Certificate\");\n\ncertInfo\
    \ = {\n    \"serverName\":\"unison-saml2-rp-sig\",\n    \"ou\":\"kubernetes\"\
    ,\n    \"o\":\"tremolo\",\n    \"l\":\"cloud\",\n    \"st\":\"cncf\",\n    \"\
    c\":\"ea\",\n    \"caCert\":false\n}\n\nx509data = CertUtils.createCertificate(certInfo);\n\
    CertUtils.saveX509ToKeystore(ouKs,ksPassword,\"unison-saml2-rp-sig\",x509data);\n\
    \nprint(\"Storing k8s and AD certs\");\nouKs.setCertificateEntry('trusted-adldaps',k8s.getCertificate('trusted-adldaps'));\n\
    ouKs.setCertificateEntry('k8s-master',k8s.getCertificate('k8s-master'));\n\nprint(\"\
    Generate Ingress Certificate\");\n\ningressCertInfo = {\n    \"serverName\": inProp[\"\
    OU_HOST\"],\n    \"ou\":inProp[\"OU_CERT_OU\"],\n    \"o\":inProp[\"OU_CERT_O\"\
    ],\n    \"l\":inProp[\"OU_CERT_L\"],\n    \"st\":inProp[\"OU_CERT_ST\"],\n   \
    \ \"c\":inProp[\"OU_CERT_C\"],\n    \"caCert\":true,\n    \"subjectAlternativeNames\"\
    :[\n        inProp[\"K8S_DASHBOARD_HOST\"]\n    ]\n}\n\ningressX509data = CertUtils.createCertificate(ingressCertInfo);\n\
    \nprint(\"Import OpenUnison certificate into keystore\");\nouKs.setCertificateEntry('unison-ca',ingressX509data.getCertificate());\n\
    \n\nprint(\"Importing the dashboard\");\n\nres = k8s.callWS('/api/v1/namespaces/kube-system/pods');\n\
    pods = JSON.parse(res.data);\n\nk8s_db_uri = null;\n\nfor (i=0;i<pods.items.length;i++)\
    \ {\n  pod = pods.items[i];\n  if (pod.metadata.name.startsWith(\"kubernetes-dashboard\"\
    )) {\n    k8s_db_uri = pod.metadata.selfLink;\n  }\n}\n\n\nif (k8s_db_uri == null)\
    \ {\n  print(\"Dashboard not present, deploying\");\n  k8s.kubectlCreateFromURL(\"\
    https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml\"\
    );\n\n  res = k8s.callWS('/api/v1/namespaces/kube-system/pods');\n  pods = JSON.parse(res.data);\n\
    \n\n  for (i=0;i<pods.items.length;i++) {\n    pod = pods.items[i];\n    if (pod.metadata.name.startsWith(\"\
    kubernetes-dashboard\")) {\n      k8s_db_uri = pod.metadata.selfLink;\n    }\n\
    \  }\n} else {\n  print(\"Skipping import of dashboard\");\n}\n\n\nprint(\"Generating\
    \ dashboard tls certificate\");\ndbCertInfo = {\n    \"serverName\":\"kubernetes-dashboard.kube-system.svc.cluster.local\"\
    ,\n    \"ou\":\"kubernetes\",\n    \"o\":\"tremolo\",\n    \"l\":\"cloud\",\n\
    \    \"st\":\"cncf\",\n    \"c\":\"ea\",\n    \"caCert\":false\n}\n\ndbX509data\
    \ = CertUtils.createCertificate(dbCertInfo);\n\nif (use_k8s_cm) {\n  print(\"\
    Creating CSR for API server\");\n\n\n\n  csrReq = {\n      \"apiVersion\": \"\
    certificates.k8s.io/v1beta1\",\n      \"kind\": \"CertificateSigningRequest\"\
    ,\n      \"metadata\": {\n        \"name\": \"kubernetes-dashboard.kube-system.svc.cluster.local\"\
    ,\n      },\n      \"spec\": {\n        \"request\": java.util.Base64.getEncoder().encodeToString(CertUtils.generateCSR(dbX509data).getBytes(\"\
    utf-8\")),\n        \"usages\": [\n          \"digital signature\",\n        \
    \  \"key encipherment\",\n          \"server auth\"\n        ]\n      }\n    };\n\
    \n  print(\"Requesting certificate\");\n  apiResp = k8s.postWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests',JSON.stringify(csrReq));\n\
    \  print(\"Approving certificate\");\n  approveReq = JSON.parse(apiResp.data);\n\
    \  approveReq.status.conditions = [\n      {\n          \"type\":\"Approved\"\
    ,\n          \"reason\":\"OpenUnison Deployment\",\n          \"message\":\"This\
    \ CSR was approved by the OpenUnison artifact deployment job\"\n      }\n  ];\n\
    \n  apiResp = k8s.putWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests/kubernetes-dashboard.kube-system.svc.cluster.local/approval',JSON.stringify(approveReq));\n\
    \  print(\"Retrieving certificate from API server\");\n  apiResp = k8s.callWS('/apis/certificates.k8s.io/v1beta1/certificatesigningrequests/kubernetes-dashboard.kube-system.svc.cluster.local','java.util.Base64.getDecoder().decode(JSON.parse(ws_response_json).status.certificate);check_ws_response=true;',10);\n\
    \  print(apiResp.data);\n  certResp = JSON.parse(apiResp.data);\n  b64cert = certResp.status.certificate;\n\
    \  CertUtils.importSignedCert(dbX509data,b64cert);\n} else {\n  //not using k8s\
    \ cm, so just import the dashboard cert into the openunison keystore\n  ouKs.setCertificateEntry(\"\
    trusted-k8s-dasboard\",dbX509data.getCertificate());\n}\nprint(\"Creating dashboard\
    \ secret\");\n\ndbsecret = {\n    \"apiVersion\":\"v1\",\n    \"kind\":\"Secret\"\
    ,\n    \"type\":\"Opaque\",\n    \"metadata\": {\n        \"name\":\"kubernetes-dashboard-certs\"\
    ,\n        \"namespace\":\"kube-system\"\n    },\n    \"data\":{\n        \"dashboard.crt\"\
    : java.util.Base64.getEncoder().encodeToString(CertUtils.exportCert(dbX509data.getCertificate()).getBytes(\"\
    UTF-8\")),\n        \"dashboard.key\": java.util.Base64.getEncoder().encodeToString(CertUtils.exportKey(dbX509data.getKeyData().getPrivate()).getBytes(\"\
    UTF-8\"))\n    }\n};\n\nres = k8s.postWS('/api/v1/namespaces/kube-system/secrets',JSON.stringify(dbsecret));\n\
    \nif (res[\"code\"] == 409) {\n  print(\"Secret alread exists, lets delete then\
    \ recreate\");\n  k8s.deleteWS('/api/v1/namespaces/kube-system/secrets/kubernetes-dashboard-certs');\n\
    \n  print(\"re-creating\");\n  k8s.postWS('/api/v1/namespaces/kube-system/secrets',JSON.stringify(dbsecret));\n\
    }\n\n\nprint(\"restarting the dashboard\")\n\nprint(\"Deleting \" + k8s_db_uri);\n\
    k8s.deleteWS(k8s_db_uri);\n\n\nprint(\"Create the openunison namespace\");\n\n\
    ouNS = {\n    \"apiVersion\":\"v1\",\n    \"kind\":\"Namespace\",\n    \"metadata\"\
    :{\n        \"creationTimestamp\":null,\n        \"name\":\"openunison\"\n   \
    \ },\n    \"spec\":{},\n    \"status\":{}\n};\n\nk8s.postWS('/api/v1/namespaces',JSON.stringify(ouNS));\n\
    \nprint(\"Create openunison service account\");\n\nk8s.postWS('/api/v1/namespaces/openunison/serviceaccounts',JSON.stringify({\"\
    apiVersion\":\"v1\",\"kind\":\"ServiceAccount\",\"metadata\":{\"creationTimestamp\"\
    :null,\"name\":\"openunison\"}}));\n\n\nprint(\"Creating RBAC Bindings\");\n\n\
    rbac = {\n    \"kind\": \"ClusterRoleBinding\",\n    \"apiVersion\": \"rbac.authorization.k8s.io/v1\"\
    ,\n    \"metadata\": {\n      \"name\": \"openunison-cluster-administrators\"\n\
    \    },\n    \"subjects\": [\n      {\n        \"kind\": \"Group\",\n        \"\
    name\": \"k8s-cluster-administrators\",\n        \"apiGroup\": \"rbac.authorization.k8s.io\"\
    \n      },\n      {\n        \"kind\": \"ServiceAccount\",\n        \"name\":\
    \ \"openunison\",\n        \"namespace\": \"openunison\"\n      }\n    ],\n  \
    \  \"roleRef\": {\n      \"kind\": \"ClusterRole\",\n      \"name\": \"cluster-admin\"\
    ,\n      \"apiGroup\": \"rbac.authorization.k8s.io\"\n    }\n  };\n\nk8s.postWS(\"\
    /apis/rbac.authorization.k8s.io/v1/clusterrolebindings\",JSON.stringify(rbac));\n\
    \nrbac = {\n    \"kind\": \"ClusterRole\",\n    \"apiVersion\": \"rbac.authorization.k8s.io/v1\"\
    ,\n    \"metadata\": {\n      \"name\": \"list-namespaces\"\n    },\n    \"rules\"\
    : [\n      {\n        \"apiGroups\": [\n          \"\"\n        ],\n        \"\
    resources\": [\n          \"namespaces\"\n        ],\n        \"verbs\": [\n \
    \         \"list\"\n        ]\n      }\n    ]\n  };\n\nk8s.postWS(\"/apis/rbac.authorization.k8s.io/v1/clusterroles\"\
    ,JSON.stringify(rbac));\n\nrbac = {\n    \"kind\": \"ClusterRoleBinding\",\n \
    \   \"apiVersion\": \"rbac.authorization.k8s.io/v1\",\n    \"metadata\": {\n \
    \     \"name\": \"openunison-cluster-list-namespaces\"\n    },\n    \"subjects\"\
    : [\n      {\n        \"kind\": \"Group\",\n        \"name\": \"users\",\n   \
    \     \"apiGroup\": \"rbac.authorization.k8s.io\"\n      }\n    ],\n    \"roleRef\"\
    : {\n      \"kind\": \"ClusterRole\",\n      \"name\": \"list-namespaces\",\n\
    \      \"apiGroup\": \"rbac.authorization.k8s.io\"\n    }\n  };\n\n\nk8s.postWS(\"\
    /apis/rbac.authorization.k8s.io/v1/clusterrolebindings\",JSON.stringify(rbac));\n\
    \nprint(\"Create Ingress TLS Secret\");\n\ningressSecret = {\n    \"apiVersion\"\
    :\"v1\",\n    \"kind\":\"Secret\",\n    \"type\":\"kubernetes.io/tls\",\n    \"\
    metadata\": {\n        \"name\":\"ou-tls-certificate\",\n        \"namespace\"\
    :\"openunison\"\n    },\n    \"data\":{\n        \"tls.crt\": java.util.Base64.getEncoder().encodeToString(CertUtils.exportCert(ingressX509data.getCertificate()).getBytes(\"\
    UTF-8\")),\n        \"tls.key\": java.util.Base64.getEncoder().encodeToString(CertUtils.exportKey(ingressX509data.getKeyData().getPrivate()).getBytes(\"\
    UTF-8\"))\n    }\n};\n\nk8s.postWS('/api/v1/namespaces/openunison/secrets',JSON.stringify(ingressSecret));\n\
    \n\n//load quartz sql\nprint(\"pulling quartz sql\");\nquartzSQL = com.tremolosecurity.kubernetes.artifacts.util.NetUtil.downloadFile(\"\
    file:///etc/input-maps/quartz.sql\");\nprint(\"parsing quartz sql\");\nparsedSQL\
    \ = com.tremolosecurity.kubernetes.artifacts.util.DbUtils.parseSQL(quartzSQL);\n\
    print(\"runnins quartz sql\");\ncom.tremolosecurity.kubernetes.artifacts.util.DbUtils.runSQL(parsedSQL,inProp[\"\
    OU_JDBC_DRIVER\"],inProp[\"OU_JDBC_URL\"],inProp[\"OU_JDBC_USER\"],inProp[\"OU_JDBC_PASSWORD\"\
    ]);\n\n//create the ip mask\nmyIp = com.tremolosecurity.kubernetes.artifacts.util.NetUtil.whatsMyIP();\n\
    mask = myIp.substring(0,myIp.indexOf(\".\"));\ninProp[\"OU_QUARTZ_MASK\"] = mask;\n\
    \nprint(\"Create activemq config secret\");\namqFileSecrets = {\n  \"apiVersion\"\
    :\"v1\",\n    \"kind\":\"Secret\",\n    \"type\":\"Opaque\",\n    \"metadata\"\
    : {\n        \"name\":\"amq-secrets\",\n        \"namespace\":\"openunison\"\n\
    \    },\n    \"data\":{\n      \"activemq.xml\":\"PCEtLQogICAgTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZSBvciBtb3JlCiAgICBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlIGRpc3RyaWJ1dGVkIHdpdGgKICAgIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4KICAgIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlIHRvIFlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wCiAgICAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aAogICAgdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKCiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKCiAgICBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAgICBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogICAgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAgICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KLS0+CjwhLS0gU1RBUlQgU05JUFBFVDogZXhhbXBsZSAtLT4KPGJlYW5zCiAgeG1sbnM9Imh0dHA6Ly93d3cuc3ByaW5nZnJhbWV3b3JrLm9yZy9zY2hlbWEvYmVhbnMiCiAgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIKICB4c2k6c2NoZW1hTG9jYXRpb249Imh0dHA6Ly93d3cuc3ByaW5nZnJhbWV3b3JrLm9yZy9zY2hlbWEvYmVhbnMgaHR0cDovL3d3dy5zcHJpbmdmcmFtZXdvcmsub3JnL3NjaGVtYS9iZWFucy9zcHJpbmctYmVhbnMueHNkCiAgaHR0cDovL2FjdGl2ZW1xLmFwYWNoZS5vcmcvc2NoZW1hL2NvcmUgaHR0cDovL2FjdGl2ZW1xLmFwYWNoZS5vcmcvc2NoZW1hL2NvcmUvYWN0aXZlbXEtY29yZS54c2QiPgoKICAgIDwhLS0gQWxsb3dzIHVzIHRvIHVzZSBzeXN0ZW0gcHJvcGVydGllcyBhcyB2YXJpYWJsZXMgaW4gdGhpcyBjb25maWd1cmF0aW9uIGZpbGUgLS0+CiAgICA8YmVhbiBjbGFzcz0ib3JnLnNwcmluZ2ZyYW1ld29yay5iZWFucy5mYWN0b3J5LmNvbmZpZy5Qcm9wZXJ0eVBsYWNlaG9sZGVyQ29uZmlndXJlciI+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9ImxvY2F0aW9ucyI+CiAgICAgICAgICAgIDx2YWx1ZT5maWxlOiR7YWN0aXZlbXEuY29uZn0vY3JlZGVudGlhbHMucHJvcGVydGllczwvdmFsdWU+CiAgICAgICAgPC9wcm9wZXJ0eT4KICAgIDwvYmVhbj4KCgoKICAgPCEtLSBBbGxvd3MgYWNjZXNzaW5nIHRoZSBzZXJ2ZXIgbG9nIC0tPgogICAgPGJlYW4gaWQ9ImxvZ1F1ZXJ5IiBjbGFzcz0iaW8uZmFicmljOC5pbnNpZ2h0LmxvZy5sb2c0ai5Mb2c0akxvZ1F1ZXJ5IgogICAgICAgICAgbGF6eS1pbml0PSJmYWxzZSIgc2NvcGU9InNpbmdsZXRvbiIKICAgICAgICAgIGluaXQtbWV0aG9kPSJzdGFydCIgZGVzdHJveS1tZXRob2Q9InN0b3AiPgogICAgPC9iZWFuPgoKICAgIDwhLS0KICAgICAgICBUaGUgPGJyb2tlcj4gZWxlbWVudCBpcyB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUgQWN0aXZlTVEgYnJva2VyLgogICAgLS0+CiAgICA8YnJva2VyIHhtbG5zPSJodHRwOi8vYWN0aXZlbXEuYXBhY2hlLm9yZy9zY2hlbWEvY29yZSIgYnJva2VyTmFtZT0ibG9jYWxob3N0IiBkYXRhRGlyZWN0b3J5PSIke2FjdGl2ZW1xLmRhdGF9Ij4KCiAgICAgICAgPGRlc3RpbmF0aW9uUG9saWN5PgogICAgICAgICAgICA8cG9saWN5TWFwPgogICAgICAgICAgICAgIDxwb2xpY3lFbnRyaWVzPgogICAgICAgICAgICAgICAgPHBvbGljeUVudHJ5IHRvcGljPSI+IiA+CiAgICAgICAgICAgICAgICAgICAgPCEtLSBUaGUgY29uc3RhbnRQZW5kaW5nTWVzc2FnZUxpbWl0U3RyYXRlZ3kgaXMgdXNlZCB0byBwcmV2ZW50CiAgICAgICAgICAgICAgICAgICAgICAgICBzbG93IHRvcGljIGNvbnN1bWVycyB0byBibG9jayBwcm9kdWNlcnMgYW5kIGFmZmVjdCBvdGhlciBjb25zdW1lcnMKICAgICAgICAgICAgICAgICAgICAgICAgIGJ5IGxpbWl0aW5nIHRoZSBudW1iZXIgb2YgbWVzc2FnZXMgdGhhdCBhcmUgcmV0YWluZWQKICAgICAgICAgICAgICAgICAgICAgICAgIEZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWU6CgogICAgICAgICAgICAgICAgICAgICAgICAgaHR0cDovL2FjdGl2ZW1xLmFwYWNoZS5vcmcvc2xvdy1jb25zdW1lci1oYW5kbGluZy5odG1sCgogICAgICAgICAgICAgICAgICAgIC0tPgogICAgICAgICAgICAgICAgICA8cGVuZGluZ01lc3NhZ2VMaW1pdFN0cmF0ZWd5PgogICAgICAgICAgICAgICAgICAgIDxjb25zdGFudFBlbmRpbmdNZXNzYWdlTGltaXRTdHJhdGVneSBsaW1pdD0iMTAwMCIvPgogICAgICAgICAgICAgICAgICA8L3BlbmRpbmdNZXNzYWdlTGltaXRTdHJhdGVneT4KICAgICAgICAgICAgICAgIDwvcG9saWN5RW50cnk+CiAgICAgICAgICAgICAgPC9wb2xpY3lFbnRyaWVzPgogICAgICAgICAgICA8L3BvbGljeU1hcD4KICAgICAgICA8L2Rlc3RpbmF0aW9uUG9saWN5PgoKCiAgICAgICAgPCEtLQogICAgICAgICAgICBUaGUgbWFuYWdlbWVudENvbnRleHQgaXMgdXNlZCB0byBjb25maWd1cmUgaG93IEFjdGl2ZU1RIGlzIGV4cG9zZWQgaW4KICAgICAgICAgICAgSk1YLiBCeSBkZWZhdWx0LCBBY3RpdmVNUSB1c2VzIHRoZSBNQmVhbiBzZXJ2ZXIgdGhhdCBpcyBzdGFydGVkIGJ5CiAgICAgICAgICAgIHRoZSBKVk0uIEZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWU6CgogICAgICAgICAgICBodHRwOi8vYWN0aXZlbXEuYXBhY2hlLm9yZy9qbXguaHRtbAogICAgICAgIC0tPgogICAgICAgIDxtYW5hZ2VtZW50Q29udGV4dD4KICAgICAgICAgICAgPG1hbmFnZW1lbnRDb250ZXh0IGNyZWF0ZUNvbm5lY3Rvcj0iZmFsc2UiLz4KICAgICAgICA8L21hbmFnZW1lbnRDb250ZXh0PgoKICAgICAgICA8IS0tCiAgICAgICAgICAgIENvbmZpZ3VyZSBtZXNzYWdlIHBlcnNpc3RlbmNlIGZvciB0aGUgYnJva2VyLiBUaGUgZGVmYXVsdCBwZXJzaXN0ZW5jZQogICAgICAgICAgICBtZWNoYW5pc20gaXMgdGhlIEthaGFEQiBzdG9yZSAoaWRlbnRpZmllZCBieSB0aGUga2FoYURCIHRhZykuCiAgICAgICAgICAgIEZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWU6CgogICAgICAgICAgICBodHRwOi8vYWN0aXZlbXEuYXBhY2hlLm9yZy9wZXJzaXN0ZW5jZS5odG1sCiAgICAgICAgLS0+CiAgICAgICAgPHBlcnNpc3RlbmNlQWRhcHRlcj4KICAgICAgIDxqZGJjUGVyc2lzdGVuY2VBZGFwdGVyCiAgICAgICAgICAgIGRhdGFEaXJlY3Rvcnk9IiR7YWN0aXZlbXEuYmFzZX0vZGF0YSIKICAgICAgICAgICAgZGF0YVNvdXJjZT0iI215c3FsLWRzIj4KICAgICAgICAgICAgPHN0YXRlbWVudHM+CiAgICAgICAgICAgICAgICA8c3RhdGVtZW50cyBiaW5hcnlEYXRhVHlwZT0iTUVESVVNQkxPQiIvPgogICAgICAgICAgICA8L3N0YXRlbWVudHM+CiAgICAgICAgPC9qZGJjUGVyc2lzdGVuY2VBZGFwdGVyPgogICAgPC9wZXJzaXN0ZW5jZUFkYXB0ZXI+CgogICAgICAgCgoKICAgICAgICAgIDwhLS0KICAgICAgICAgICAgVGhlIHN5c3RlbVVzYWdlIGNvbnRyb2xzIHRoZSBtYXhpbXVtIGFtb3VudCBvZiBzcGFjZSB0aGUgYnJva2VyIHdpbGwKICAgICAgICAgICAgdXNlIGJlZm9yZSBkaXNhYmxpbmcgY2FjaGluZyBhbmQvb3Igc2xvd2luZyBkb3duIHByb2R1Y2Vycy4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZToKICAgICAgICAgICAgaHR0cDovL2FjdGl2ZW1xLmFwYWNoZS5vcmcvcHJvZHVjZXItZmxvdy1jb250cm9sLmh0bWwKICAgICAgICAgIC0tPgogICAgICAgICAgPHN5c3RlbVVzYWdlPgogICAgICAgICAgICA8c3lzdGVtVXNhZ2U+CiAgICAgICAgICAgICAgICA8bWVtb3J5VXNhZ2U+CiAgICAgICAgICAgICAgICAgICAgPG1lbW9yeVVzYWdlIHBlcmNlbnRPZkp2bUhlYXA9IjcwIiAvPgogICAgICAgICAgICAgICAgPC9tZW1vcnlVc2FnZT4KICAgICAgICAgICAgICAgIDxzdG9yZVVzYWdlPgogICAgICAgICAgICAgICAgICAgIDxzdG9yZVVzYWdlIGxpbWl0PSIyNTYgbWIiLz4KICAgICAgICAgICAgICAgIDwvc3RvcmVVc2FnZT4KICAgICAgICAgICAgICAgIDx0ZW1wVXNhZ2U+CiAgICAgICAgICAgICAgICAgICAgPHRlbXBVc2FnZSBsaW1pdD0iMjU2IG1iIi8+CiAgICAgICAgICAgICAgICA8L3RlbXBVc2FnZT4KICAgICAgICAgICAgPC9zeXN0ZW1Vc2FnZT4KICAgICAgICA8L3N5c3RlbVVzYWdlPgoKICAgICAgICA8IS0tCiAgICAgICAgICAgIFRoZSB0cmFuc3BvcnQgY29ubmVjdG9ycyBleHBvc2UgQWN0aXZlTVEgb3ZlciBhIGdpdmVuIHByb3RvY29sIHRvCiAgICAgICAgICAgIGNsaWVudHMgYW5kIG90aGVyIGJyb2tlcnMuIEZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWU6CgogICAgICAgICAgICBodHRwOi8vYWN0aXZlbXEuYXBhY2hlLm9yZy9jb25maWd1cmluZy10cmFuc3BvcnRzLmh0bWwKICAgICAgICAtLT4KICAgICAgICAgPHNzbENvbnRleHQ+CiAgICAgICAgICAgIDxzc2xDb250ZXh0CiAgICAgICAgICAgICAgICAgICAga2V5U3RvcmU9Ii9ldGMvYWN0aXZlbXEvYW1xLnAxMiIga2V5U3RvcmVQYXNzd29yZD0iJHtUTFNfS1NfUFdEfSIKICAgICAgICAgICAgICAgICAgICB0cnVzdFN0b3JlPSIvZXRjL2FjdGl2ZW1xL2FtcS5wMTIiIHRydXN0U3RvcmVQYXNzd29yZD0iJHtUTFNfS1NfUFdEfSIgdHJ1c3RTdG9yZVR5cGU9InBrY3MxMiIga2V5U3RvcmVUeXBlPSJwa2NzMTIiLz4KICAgICAgICAgICAgPC9zc2xDb250ZXh0PgogICAgICAgIDx0cmFuc3BvcnRDb25uZWN0b3JzPgogICAgICAgICAgICA8IS0tIERPUyBwcm90ZWN0aW9uLCBsaW1pdCBjb25jdXJyZW50IGNvbm5lY3Rpb25zIHRvIDEwMDAgYW5kIGZyYW1lIHNpemUgdG8gMTAwTUIgLS0+CiAgICAgICAgICAgIDx0cmFuc3BvcnRDb25uZWN0b3IgbmFtZT0ib3BlbndpcmUiIHVyaT0ic3NsOi8vMC4wLjAuMDo2MTYxNj9tYXhpbXVtQ29ubmVjdGlvbnM9MTAwMCZhbXA7d2lyZUZvcm1hdC5tYXhGcmFtZVNpemU9MTA0ODU3NjAwJmFtcDtuZWVkQ2xpZW50QXV0aD10cnVlIi8+CiAgICAgICAgPC90cmFuc3BvcnRDb25uZWN0b3JzPgoKICAgICAgICA8IS0tIGRlc3Ryb3kgdGhlIHNwcmluZyBjb250ZXh0IG9uIHNodXRkb3duIHRvIHN0b3AgamV0dHkgLS0+CiAgICAgICAgPHNodXRkb3duSG9va3M+CiAgICAgICAgICAgIDxiZWFuIHhtbG5zPSJodHRwOi8vd3d3LnNwcmluZ2ZyYW1ld29yay5vcmcvc2NoZW1hL2JlYW5zIiBjbGFzcz0ib3JnLmFwYWNoZS5hY3RpdmVtcS5ob29rcy5TcHJpbmdDb250ZXh0SG9vayIgLz4KICAgICAgICA8L3NodXRkb3duSG9va3M+CgogICAgPC9icm9rZXI+CgogICAgPCEtLQogICAgICAgIEVuYWJsZSB3ZWIgY29uc29sZXMsIFJFU1QgYW5kIEFqYXggQVBJcyBhbmQgZGVtb3MKICAgICAgICBUaGUgd2ViIGNvbnNvbGVzIHJlcXVpcmVzIGJ5IGRlZmF1bHQgbG9naW4sIHlvdSBjYW4gZGlzYWJsZSB0aGlzIGluIHRoZSBqZXR0eS54bWwgZmlsZQoKICAgICAgICBUYWtlIGEgbG9vayBhdCAke0FDVElWRU1RX0hPTUV9L2NvbmYvamV0dHkueG1sIGZvciBtb3JlIGRldGFpbHMKICAgIC0tPgogICAgPCEtLSA8aW1wb3J0IHJlc291cmNlPSJmaWxlOi8vL3Vzci9sb2NhbC9hY3RpdmVtcS9jb25mL2pldHR5LnhtbCIvPiAtLT4KICAgIDxiZWFuIGlkPSJzZWN1cml0eUxvZ2luU2VydmljZSIgY2xhc3M9Im9yZy5lY2xpcHNlLmpldHR5LnNlY3VyaXR5Lkhhc2hMb2dpblNlcnZpY2UiPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJuYW1lIiB2YWx1ZT0iQWN0aXZlTVFSZWFsbSIgLz4KICAgICAgICA8cHJvcGVydHkgbmFtZT0iY29uZmlnIiB2YWx1ZT0iJHthY3RpdmVtcS5jb25mfS9qZXR0eS1yZWFsbS5wcm9wZXJ0aWVzIiAvPgogICAgPC9iZWFuPgoKICAgIDxiZWFuIGlkPSJzZWN1cml0eUNvbnN0cmFpbnQiIGNsYXNzPSJvcmcuZWNsaXBzZS5qZXR0eS51dGlsLnNlY3VyaXR5LkNvbnN0cmFpbnQiPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJuYW1lIiB2YWx1ZT0iQkFTSUMiIC8+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9InJvbGVzIiB2YWx1ZT0idXNlcixhZG1pbiIgLz4KICAgICAgICA8IS0tIHNldCBhdXRoZW50aWNhdGU9ZmFsc2UgdG8gZGlzYWJsZSBsb2dpbiAtLT4KICAgICAgICA8cHJvcGVydHkgbmFtZT0iYXV0aGVudGljYXRlIiB2YWx1ZT0iZmFsc2UiIC8+CiAgICA8L2JlYW4+CiAgICA8YmVhbiBpZD0iYWRtaW5TZWN1cml0eUNvbnN0cmFpbnQiIGNsYXNzPSJvcmcuZWNsaXBzZS5qZXR0eS51dGlsLnNlY3VyaXR5LkNvbnN0cmFpbnQiPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJuYW1lIiB2YWx1ZT0iQkFTSUMiIC8+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9InJvbGVzIiB2YWx1ZT0iYWRtaW4iIC8+CiAgICAgICAgIDwhLS0gc2V0IGF1dGhlbnRpY2F0ZT1mYWxzZSB0byBkaXNhYmxlIGxvZ2luIC0tPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJhdXRoZW50aWNhdGUiIHZhbHVlPSJmYWxzZSIgLz4KICAgIDwvYmVhbj4KICAgIDxiZWFuIGlkPSJzZWN1cml0eUNvbnN0cmFpbnRNYXBwaW5nIiBjbGFzcz0ib3JnLmVjbGlwc2UuamV0dHkuc2VjdXJpdHkuQ29uc3RyYWludE1hcHBpbmciPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJjb25zdHJhaW50IiByZWY9InNlY3VyaXR5Q29uc3RyYWludCIgLz4KICAgICAgICA8cHJvcGVydHkgbmFtZT0icGF0aFNwZWMiIHZhbHVlPSIvYXBpLyosL2FkbWluLyosKi5qc3AiIC8+CiAgICA8L2JlYW4+CiAgICA8YmVhbiBpZD0iYWRtaW5TZWN1cml0eUNvbnN0cmFpbnRNYXBwaW5nIiBjbGFzcz0ib3JnLmVjbGlwc2UuamV0dHkuc2VjdXJpdHkuQ29uc3RyYWludE1hcHBpbmciPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJjb25zdHJhaW50IiByZWY9ImFkbWluU2VjdXJpdHlDb25zdHJhaW50IiAvPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJwYXRoU3BlYyIgdmFsdWU9IiouYWN0aW9uIiAvPgogICAgPC9iZWFuPgogICAgCiAgICA8YmVhbiBpZD0icmV3cml0ZUhhbmRsZXIiIGNsYXNzPSJvcmcuZWNsaXBzZS5qZXR0eS5yZXdyaXRlLmhhbmRsZXIuUmV3cml0ZUhhbmRsZXIiPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJydWxlcyI+CiAgICAgICAgICAgIDxsaXN0PgogICAgICAgICAgICAgICAgPGJlYW4gaWQ9ImhlYWRlciIgY2xhc3M9Im9yZy5lY2xpcHNlLmpldHR5LnJld3JpdGUuaGFuZGxlci5IZWFkZXJQYXR0ZXJuUnVsZSI+CiAgICAgICAgICAgICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJwYXR0ZXJuIiB2YWx1ZT0iKiIvPgogICAgICAgICAgICAgICAgICA8cHJvcGVydHkgbmFtZT0ibmFtZSIgdmFsdWU9IlgtRlJBTUUtT1BUSU9OUyIvPgogICAgICAgICAgICAgICAgICA8cHJvcGVydHkgbmFtZT0idmFsdWUiIHZhbHVlPSJTQU1FT1JJR0lOIi8+CiAgICAgICAgICAgICAgICA8L2JlYW4+CiAgICAgICAgICAgIDwvbGlzdD4KICAgICAgICA8L3Byb3BlcnR5PgogICAgPC9iZWFuPgogICAgCgk8YmVhbiBpZD0ic2VjSGFuZGxlckNvbGxlY3Rpb24iIGNsYXNzPSJvcmcuZWNsaXBzZS5qZXR0eS5zZXJ2ZXIuaGFuZGxlci5IYW5kbGVyQ29sbGVjdGlvbiI+CgkJPHByb3BlcnR5IG5hbWU9ImhhbmRsZXJzIj4KCQkJPGxpc3Q+CiAgIAkgICAgICAgICAgICA8cmVmIGJlYW49InJld3JpdGVIYW5kbGVyIi8+CgkJCQk8YmVhbiBjbGFzcz0ib3JnLmVjbGlwc2UuamV0dHkud2ViYXBwLldlYkFwcENvbnRleHQiPgoJCQkJCTxwcm9wZXJ0eSBuYW1lPSJjb250ZXh0UGF0aCIgdmFsdWU9Ii9hZG1pbiIgLz4KCQkJCQk8cHJvcGVydHkgbmFtZT0icmVzb3VyY2VCYXNlIiB2YWx1ZT0iJHthY3RpdmVtcS5ob21lfS93ZWJhcHBzL2FkbWluIiAvPgoJCQkJCTxwcm9wZXJ0eSBuYW1lPSJsb2dVcmxPblN0YXJ0IiB2YWx1ZT0idHJ1ZSIgLz4KCQkJCTwvYmVhbj4KCQkJCTxiZWFuIGNsYXNzPSJvcmcuZWNsaXBzZS5qZXR0eS53ZWJhcHAuV2ViQXBwQ29udGV4dCI+CgkJCQkJPHByb3BlcnR5IG5hbWU9ImNvbnRleHRQYXRoIiB2YWx1ZT0iL2FwaSIgLz4KCQkJCQk8cHJvcGVydHkgbmFtZT0icmVzb3VyY2VCYXNlIiB2YWx1ZT0iJHthY3RpdmVtcS5ob21lfS93ZWJhcHBzL2FwaSIgLz4KCQkJCQk8cHJvcGVydHkgbmFtZT0ibG9nVXJsT25TdGFydCIgdmFsdWU9InRydWUiIC8+CgkJCQk8L2JlYW4+CgkJCQk8YmVhbiBjbGFzcz0ib3JnLmVjbGlwc2UuamV0dHkuc2VydmVyLmhhbmRsZXIuUmVzb3VyY2VIYW5kbGVyIj4KCQkJCQk8cHJvcGVydHkgbmFtZT0iZGlyZWN0b3JpZXNMaXN0ZWQiIHZhbHVlPSJmYWxzZSIgLz4KCQkJCQk8cHJvcGVydHkgbmFtZT0id2VsY29tZUZpbGVzIj4KCQkJCQkJPGxpc3Q+CgkJCQkJCQk8dmFsdWU+aW5kZXguaHRtbDwvdmFsdWU+CgkJCQkJCTwvbGlzdD4KCQkJCQk8L3Byb3BlcnR5PgoJCQkJCTxwcm9wZXJ0eSBuYW1lPSJyZXNvdXJjZUJhc2UiIHZhbHVlPSIke2FjdGl2ZW1xLmhvbWV9L3dlYmFwcHMvIiAvPgoJCQkJPC9iZWFuPgoJCQkJPGJlYW4gaWQ9ImRlZmF1bHRIYW5kbGVyIiBjbGFzcz0ib3JnLmVjbGlwc2UuamV0dHkuc2VydmVyLmhhbmRsZXIuRGVmYXVsdEhhbmRsZXIiPgoJCQkJCTxwcm9wZXJ0eSBuYW1lPSJzZXJ2ZUljb24iIHZhbHVlPSJmYWxzZSIgLz4KCQkJCTwvYmVhbj4KCQkJPC9saXN0PgoJCTwvcHJvcGVydHk+Cgk8L2JlYW4+ICAgIAogICAgPGJlYW4gaWQ9InNlY3VyaXR5SGFuZGxlciIgY2xhc3M9Im9yZy5lY2xpcHNlLmpldHR5LnNlY3VyaXR5LkNvbnN0cmFpbnRTZWN1cml0eUhhbmRsZXIiPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJsb2dpblNlcnZpY2UiIHJlZj0ic2VjdXJpdHlMb2dpblNlcnZpY2UiIC8+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9ImF1dGhlbnRpY2F0b3IiPgogICAgICAgICAgICA8YmVhbiBjbGFzcz0ib3JnLmVjbGlwc2UuamV0dHkuc2VjdXJpdHkuYXV0aGVudGljYXRpb24uQmFzaWNBdXRoZW50aWNhdG9yIiAvPgogICAgICAgIDwvcHJvcGVydHk+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9ImNvbnN0cmFpbnRNYXBwaW5ncyI+CiAgICAgICAgICAgIDxsaXN0PgogICAgICAgICAgICAgICAgPHJlZiBiZWFuPSJhZG1pblNlY3VyaXR5Q29uc3RyYWludE1hcHBpbmciIC8+CiAgICAgICAgICAgICAgICA8cmVmIGJlYW49InNlY3VyaXR5Q29uc3RyYWludE1hcHBpbmciIC8+CiAgICAgICAgICAgIDwvbGlzdD4KICAgICAgICA8L3Byb3BlcnR5PgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJoYW5kbGVyIiByZWY9InNlY0hhbmRsZXJDb2xsZWN0aW9uIiAvPgogICAgPC9iZWFuPgoKICAgIDxiZWFuIGlkPSJjb250ZXh0cyIgY2xhc3M9Im9yZy5lY2xpcHNlLmpldHR5LnNlcnZlci5oYW5kbGVyLkNvbnRleHRIYW5kbGVyQ29sbGVjdGlvbiI+CiAgICA8L2JlYW4+CgogIDwhLS0gIDxiZWFuIGlkPSJqZXR0eVBvcnQiIGNsYXNzPSJvcmcuYXBhY2hlLmFjdGl2ZW1xLndlYi5XZWJDb25zb2xlUG9ydCIgaW5pdC1tZXRob2Q9InN0YXJ0Ij4KICAgICAgICAgICAgCiAgICAgICAgPHByb3BlcnR5IG5hbWU9Imhvc3QiIHZhbHVlPSIwLjAuMC4wIi8+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9InBvcnQiIHZhbHVlPSI4MTYxIi8+CiAgICA8L2JlYW4gLS0+CgogICAgPGJlYW4gaWQ9IlNlcnZlciIgY2xhc3M9Im9yZy5lY2xpcHNlLmpldHR5LnNlcnZlci5TZXJ2ZXIiCiAgICAgICAgZGVzdHJveS1tZXRob2Q9InN0b3AiPgoKICAgICAgICA8cHJvcGVydHkgbmFtZT0iaGFuZGxlciI+CiAgICAgICAgICAgIDxiZWFuIGlkPSJoYW5kbGVycyIgY2xhc3M9Im9yZy5lY2xpcHNlLmpldHR5LnNlcnZlci5oYW5kbGVyLkhhbmRsZXJDb2xsZWN0aW9uIj4KICAgICAgICAgICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJoYW5kbGVycyI+CiAgICAgICAgICAgICAgICAgICAgPGxpc3Q+CiAgICAgICAgICAgICAgICAgICAgICAgIDxyZWYgYmVhbj0iY29udGV4dHMiIC8+CiAgICAgICAgICAgICAgICAgICAgICAgIDxyZWYgYmVhbj0ic2VjdXJpdHlIYW5kbGVyIiAvPgogICAgICAgICAgICAgICAgICAgIDwvbGlzdD4KICAgICAgICAgICAgICAgIDwvcHJvcGVydHk+CiAgICAgICAgICAgIDwvYmVhbj4KICAgICAgICA8L3Byb3BlcnR5PgoKICAgIDwvYmVhbj4KCiAgICAKCiAgICA8YmVhbiBpZD0iaW52b2tlQ29ubmVjdG9ycyIgY2xhc3M9Im9yZy5zcHJpbmdmcmFtZXdvcmsuYmVhbnMuZmFjdG9yeS5jb25maWcuTWV0aG9kSW52b2tpbmdGYWN0b3J5QmVhbiI+CiAgICAJPHByb3BlcnR5IG5hbWU9InRhcmdldE9iamVjdCIgcmVmPSJTZXJ2ZXIiIC8+CiAgICAJPHByb3BlcnR5IG5hbWU9InRhcmdldE1ldGhvZCIgdmFsdWU9InNldENvbm5lY3RvcnMiIC8+CiAgICAJPHByb3BlcnR5IG5hbWU9ImFyZ3VtZW50cyI+CiAgICAJPGxpc3Q+CiAgICAgICAgICAgCTxiZWFuIGlkPSJDb25uZWN0b3IiIGNsYXNzPSJvcmcuZWNsaXBzZS5qZXR0eS5zZXJ2ZXIuU2VydmVyQ29ubmVjdG9yIj4KICAgICAgICAgICAJCTxjb25zdHJ1Y3Rvci1hcmcgcmVmPSJTZXJ2ZXIiIC8+CiAgICAgICAgICAgICAgICAgICAgPCEtLSBzZWUgdGhlIGpldHR5UG9ydCBiZWFuIC0tPgogICAgICAgICAgICAgICAgICAgPHByb3BlcnR5IG5hbWU9Imhvc3QiIHZhbHVlPSIxMjcuMC4wLjEiIC8+CiAgICAgICAgICAgICAgICAgICA8cHJvcGVydHkgbmFtZT0icG9ydCIgdmFsdWU9IjgxNjEiIC8+CiAgICAgICAgICAgICAgIDwvYmVhbj4KICAgICAgICAgICAgICAgIDwhLS0KICAgICAgICAgICAgICAgICAgICBFbmFibGUgdGhpcyBjb25uZWN0b3IgaWYgeW91IHdpc2ggdG8gdXNlIGh0dHBzIHdpdGggd2ViIGNvbnNvbGUKICAgICAgICAgICAgICAgIC0tPgogICAgICAgICAgICAgICAgPGJlYW4gaWQ9IlNlY3VyZUNvbm5lY3RvciIgY2xhc3M9Im9yZy5lY2xpcHNlLmpldHR5LnNlcnZlci5TZXJ2ZXJDb25uZWN0b3IiPgoJCQkJCTxjb25zdHJ1Y3Rvci1hcmcgcmVmPSJTZXJ2ZXIiIC8+CgkJCQkJPGNvbnN0cnVjdG9yLWFyZz4KCQkJCQkJPGJlYW4gaWQ9ImhhbmRsZXJzIiBjbGFzcz0ib3JnLmVjbGlwc2UuamV0dHkudXRpbC5zc2wuU3NsQ29udGV4dEZhY3RvcnkiPgoJCQkJCQkKCQkJCQkJCTxwcm9wZXJ0eSBuYW1lPSJrZXlTdG9yZVBhdGgiIHZhbHVlPSIvZXRjL2FjdGl2ZW1xL2FtcS5wMTIiIC8+CgkJCQkJCQk8cHJvcGVydHkgbmFtZT0ia2V5U3RvcmVQYXNzd29yZCIgdmFsdWU9IiR7VExTX0tTX1BXRH0iIC8+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8cHJvcGVydHkgbmFtZT0ia2V5U3RvcmVUeXBlIiB2YWx1ZT0icGtjczEyIiAvPgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJ0cnVzdFN0b3JlUGF0aCIgdmFsdWU9Ii9ldGMvYWN0aXZlbXEvYW1xLnAxMiIgLz4KCQkJCQkJCTxwcm9wZXJ0eSBuYW1lPSJ0cnVzdFN0b3JlUGFzc3dvcmQiIHZhbHVlPSIke1RMU19LU19QV0R9IiAvPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHByb3BlcnR5IG5hbWU9InRydXN0U3RvcmVUeXBlIiB2YWx1ZT0icGtjczEyIiAvPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHByb3BlcnR5IG5hbWU9Im5lZWRDbGllbnRBdXRoIiB2YWx1ZT0idHJ1ZSIgLz4KCgkJCQkJCTwvYmVhbj4KCQkJCQk8L2NvbnN0cnVjdG9yLWFyZz4KCQkJCQk8cHJvcGVydHkgbmFtZT0icG9ydCIgdmFsdWU9IjgxNjIiIC8+CgkJCQk8L2JlYW4+CiAgICAgICAgICAgIDwvbGlzdD4KICAgIAk8L3Byb3BlcnR5PgogICAgPC9iZWFuPgoKCTxiZWFuIGlkPSJjb25maWd1cmVKZXR0eSIgY2xhc3M9Im9yZy5zcHJpbmdmcmFtZXdvcmsuYmVhbnMuZmFjdG9yeS5jb25maWcuTWV0aG9kSW52b2tpbmdGYWN0b3J5QmVhbiI+CgkJPHByb3BlcnR5IG5hbWU9InN0YXRpY01ldGhvZCIgdmFsdWU9Im9yZy5hcGFjaGUuYWN0aXZlbXEud2ViLmNvbmZpZy5Kc3BDb25maWd1cmVyLmNvbmZpZ3VyZUpldHR5IiAvPgoJCTxwcm9wZXJ0eSBuYW1lPSJhcmd1bWVudHMiPgoJCQk8bGlzdD4KCQkJCTxyZWYgYmVhbj0iU2VydmVyIiAvPgoJCQkJPHJlZiBiZWFuPSJzZWNIYW5kbGVyQ29sbGVjdGlvbiIgLz4KCQkJPC9saXN0PgoJCTwvcHJvcGVydHk+Cgk8L2JlYW4+CiAgICAKICAgIDxiZWFuIGlkPSJpbnZva2VTdGFydCIgY2xhc3M9Im9yZy5zcHJpbmdmcmFtZXdvcmsuYmVhbnMuZmFjdG9yeS5jb25maWcuTWV0aG9kSW52b2tpbmdGYWN0b3J5QmVhbiIgCiAgICAJZGVwZW5kcy1vbj0iY29uZmlndXJlSmV0dHksIGludm9rZUNvbm5lY3RvcnMiPgogICAgCTxwcm9wZXJ0eSBuYW1lPSJ0YXJnZXRPYmplY3QiIHJlZj0iU2VydmVyIiAvPgogICAgCTxwcm9wZXJ0eSBuYW1lPSJ0YXJnZXRNZXRob2QiIHZhbHVlPSJzdGFydCIgLz4gIAkKICAgIDwvYmVhbj4KCiAgICAgICAgPCEtLSBzZXR1cCBteXNxbCBhY2Nlc3MgLS0+CiAgICA8YmVhbiBpZD0ibXlzcWwtZHMiIGNsYXNzPSJvcmcuYXBhY2hlLmNvbW1vbnMuZGJjcC5CYXNpY0RhdGFTb3VyY2UiIGRlc3Ryb3ktbWV0aG9kPSJjbG9zZSI+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9ImRyaXZlckNsYXNzTmFtZSIgdmFsdWU9IiN7c3lzdGVtRW52aXJvbm1lbnRbJ0pEQkNfRFJJVkVSJ119Ii8+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9InVybCIgdmFsdWU9IiR7SkRCQ19VUkx9Ii8+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9InVzZXJuYW1lIiB2YWx1ZT0iI3tzeXN0ZW1FbnZpcm9ubWVudFsnSkRCQ19VU0VSJ119Ii8+CiAgICAgICAgPHByb3BlcnR5IG5hbWU9InBhc3N3b3JkIiB2YWx1ZT0iI3tzeXN0ZW1FbnZpcm9ubWVudFsnSkRCQ19QQVNTV09SRCddfSIvPgogICAgICAgIDxwcm9wZXJ0eSBuYW1lPSJwb29sUHJlcGFyZWRTdGF0ZW1lbnRzIiB2YWx1ZT0idHJ1ZSIvPgogICAgPC9iZWFuPgoKPC9iZWFucz4KPCEtLSBFTkQgU05JUFBFVDogZXhhbXBsZSAtLT4=\"\
    ,\n      \"amq.p12\":CertUtils.encodeKeyStore(amqKS,ksPassword)\n    }\n}\n\n\
    k8s.postWS('/api/v1/namespaces/openunison/secrets',JSON.stringify(amqFileSecrets));\n\
    \nprint(\"Create activemq env var secret\");\n\namqEnvSecrets = {\n  \"apiVersion\"\
    :\"v1\",\n    \"kind\":\"Secret\",\n    \"type\":\"Opaque\",\n    \"metadata\"\
    : {\n        \"name\":\"amq-env-secrets\",\n        \"namespace\":\"openunison\"\
    \n    },\n    \"data\":{\n      \"JDBC_DRIVER\":java.util.Base64.getEncoder().encodeToString(inProp['OU_JDBC_DRIVER'].getBytes(\"\
    UTF-8\")),\n      \"JDBC_URL\":java.util.Base64.getEncoder().encodeToString(inProp['OU_JDBC_URL'].getBytes(\"\
    UTF-8\")),\n      \"JDBC_USER\":java.util.Base64.getEncoder().encodeToString(inProp['OU_JDBC_USER'].getBytes(\"\
    UTF-8\")),\n      \"JDBC_PASSWORD\":java.util.Base64.getEncoder().encodeToString(inProp['OU_JDBC_PASSWORD'].getBytes(\"\
    UTF-8\")),\n      \"TLS_KS_PWD\":java.util.Base64.getEncoder().encodeToString(ksPassword.getBytes(\"\
    UTF-8\"))\n    }\n}\n\nk8s.postWS('/api/v1/namespaces/openunison/secrets',JSON.stringify(amqEnvSecrets));\n\
    \nprint(\"Create OpenUnison Secret\");\n\n\nouSecrets = {\n    \"apiVersion\"\
    :\"v1\",\n    \"kind\":\"Secret\",\n    \"type\":\"Opaque\",\n    \"metadata\"\
    : {\n        \"name\":\"openunison-secrets\",\n        \"namespace\":\"openunison\"\
    \n    },\n    \"data\":{\n      \"openunison.yaml\":\"LS0tCm9wZW5fcG9ydDogODA4MApvcGVuX2V4dGVybmFsX3BvcnQ6IDgwCnNlY3VyZV9wb3J0OiA4NDQzCnNlY3VyZV9leHRlcm5hbF9wb3J0OiA0NDMKc2VjdXJlX2tleV9hbGlhczogInVuaXNvbi10bHMiCmZvcmNlX3RvX3NlY3VyZTogdHJ1ZQphY3RpdmVtcV9kaXI6ICIvdG1wL2FtcSIKcXVhcnR6X2RpcjogIi90bXAvcXVhcnR6IgpjbGllbnRfYXV0aDogbm9uZQpkaXNhYmxlX2h0dHAyOiB0cnVlCmFsbG93ZWRfY2xpZW50X25hbWVzOiBbXQpjaXBoZXJzOgotIFRMU19FQ0RIRV9SU0FfV0lUSF9BRVNfMTI4X0dDTV9TSEEyNTYKLSBUTFNfRUNESEVfUlNBX1dJVEhfQUVTXzEyOF9DQkNfU0hBMjU2Ci0gVExTX0VDREhFX1JTQV9XSVRIX0FFU18xMjhfQ0JDX1NIQQotIFRMU19FQ0RIRV9SU0FfV0lUSF9BRVNfMjU2X0dDTV9TSEEzODQKLSBUTFNfRUNESEVfUlNBX1dJVEhfQUVTXzI1Nl9DQkNfU0hBMzg0Ci0gVExTX0VDREhFX1JTQV9XSVRIX0FFU18yNTZfQ0JDX1NIQQphbGxvd2VkX3Rsc19wcm90b2NvbHM6Ci0gVExTdjEuMgpwYXRoX3RvX2RlcGxveW1lbnQ6ICIvdXNyL2xvY2FsL29wZW51bmlzb24vd29yayIKcGF0aF90b19lbnZfZmlsZTogIi9ldGMvb3BlbnVuaXNvbi9vdS5lbnYiCgo=\"\
    ,\n      \"ou.env\":k8s.encodeMap(inProp),\n      \"unisonKeyStore.p12\":CertUtils.encodeKeyStore(ouKs,ksPassword)\n\
    \    }\n}\n\nk8s.postWS('/api/v1/namespaces/openunison/secrets',JSON.stringify(ouSecrets));\n\
    \nprint(\"Creating post deployment configmap\");\n\noidcFlags = \"--oidc-issuer-url=https://\"\
    \ + inProp[\"OU_HOST\"] + \"/auth/idp/k8sIdp\\n\" +\n            \"--oidc-client-id=kubernetes\\\
    n\" +\n            \"--oidc-username-claim=sub\\n\" + \n            \"--oidc-groups-claim=groups\\\
    n\" +\n            \"--oidc-ca-file=/etc/kubernetes/pki/ou-ca.pem\";\n\ncanonicalOidcFlags\
    \ = \"oidc-issuer-url=https://\" + inProp[\"OU_HOST\"] + \"/auth/idp/k8sIdp \"\
    \ +\n                      \"oidc-client-id=kubernetes \" +\n                \
    \      \"oidc-username-claim=sub \" + \n                      \"oidc-groups-claim=groups\
    \ \" +\n                      \"oidc-ca-file=/root/cdk/ou-ca.pem\";\n\nprint(\"\
    Runing kubectl create\");\nk8s.kubectlCreate(k8s.processTemplate(deploymentTemplate,inProp));\n\
    print(\"kubectl complete\");\n\n\n\n\n\n\n\n\n\n\n\n\ncfgMap = {\n    \"apiVersion\"\
    :\"v1\",\n    \"kind\":\"ConfigMap\",\n    \"metadata\":{\n        \"name\":\"\
    api-server-config\",\n        \"namespace\":\"openunison\"\n    },\n    \"data\"\
    :{\n        \"oidc-api-server-flags\":oidcFlags,\n        \"ou-ca.pem-base64-encoded\"\
    :CertUtils.exportCert(ingressX509data.getCertificate()),\n        \"canonical-cdk-flags\"\
    :canonicalOidcFlags,\n        \"oidc-issuer-url\":\"https://\" + inProp[\"OU_HOST\"\
    ] + \"/auth/idp/k8sIdp\",\n        \"oidc-client-id\":\"kubernetes\",\n      \
    \  \"oidc-username-claim\":\"sub\",\n        \"oidc-groups-claim\":\"groups\"\
    ,\n        \"oidc-ca-file\":\"/etc/kubernetes/pki/ou-ca.pem\"\n        \n    \
    \    //\"deployment\":java.util.Base64.getEncoder().encodeToString(k8s.processTemplate(deploymentTemplate,inProp).getBytes(\"\
    UTF-8\"))\n    }\n};\n\nk8s.postWS('/api/v1/namespaces/openunison/configmaps',JSON.stringify(cfgMap));\n\
    \nprint(\"Deleting cluster role binding\");\nk8s.deleteWS('/apis/rbac.authorization.k8s.io/v1/clusterrolebindings/artifact-deployment');\n\
    \nprint(\"Artifacts Created, to configure the API server run 'kubectl describe\
    \ configmap api-server-config -n openunison'\");"
  openunison.yaml: "# ActiveMQ\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n\
    \    app: amq\n  name: amq\n  namespace: openunison\nspec:\n  ports:\n  - name:\
    \ amq-openwire\n    port: 61616\n    protocol: TCP\n    targetPort: 61616\n  -\
    \ name: amq-admin\n    port: 8162\n    protocol: TCP\n    targetPort: 8162\n \
    \ selector:\n    app: amq\n  sessionAffinity: ClientIP\n  sessionAffinityConfig:\n\
    \    clientIP:\n      timeoutSeconds: 10800\n  type: ClusterIP\nstatus:\n  loadBalancer:\
    \ {}\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n\
    \    app: amq\n  name: amq\n  namespace: openunison\nspec:\n  progressDeadlineSeconds:\
    \ 600\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n\
    \      app: amq\n  strategy:\n    rollingUpdate:\n      maxSurge: 25%\n      maxUnavailable:\
    \ 25%\n    type: RollingUpdate\n  template:\n    metadata:\n      creationTimestamp:\
    \ null\n      labels:\n        app: amq\n    spec:\n      containers:\n      -\
    \ env:\n        - name: JAVA_OPTS\n          value: -Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom\n\
    \        - name: JDBC_DRIVER\n          valueFrom:\n            secretKeyRef:\n\
    \              name: amq-env-secrets\n              key: JDBC_DRIVER\n       \
    \ - name: JDBC_URL\n          valueFrom:\n            secretKeyRef:\n        \
    \      name: amq-env-secrets\n              key: JDBC_URL\n        - name: JDBC_USER\n\
    \          valueFrom:\n            secretKeyRef:\n              name: amq-env-secrets\n\
    \              key: JDBC_USER\n        - name: JDBC_PASSWORD\n          valueFrom:\n\
    \            secretKeyRef:\n              name: amq-env-secrets\n            \
    \  key: JDBC_PASSWORD\n        - name: TLS_KS_PWD\n          valueFrom:\n    \
    \        secretKeyRef:\n              name: amq-env-secrets\n              key:\
    \ TLS_KS_PWD\n        image: docker.io/tremolosecurity/activemq-docker\n     \
    \   imagePullPolicy: Always\n        livenessProbe:\n          exec:\n       \
    \     command:\n            - /usr/bin/health_check.sh\n          failureThreshold:\
    \ 10\n          initialDelaySeconds: 10\n          periodSeconds: 10\n       \
    \   successThreshold: 1\n          timeoutSeconds: 10\n        name: openunison\n\
    \        ports:\n        - containerPort: 8080\n          name: http\n       \
    \   protocol: TCP\n        - containerPort: 8443\n          name: https\n    \
    \      protocol: TCP\n        readinessProbe:\n          exec:\n            command:\n\
    \            - /usr/bin/health_check.sh\n          failureThreshold: 3\n     \
    \     initialDelaySeconds: 10\n          periodSeconds: 10\n          successThreshold:\
    \ 1\n          timeoutSeconds: 10\n        resources: {}\n        terminationMessagePath:\
    \ /dev/termination-log\n        terminationMessagePolicy: File\n        volumeMounts:\n\
    \        - mountPath: /etc/activemq\n          name: secret-volume\n         \
    \ readOnly: true\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n\
    \      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: secret-volume\n\
    \        secret:\n          defaultMode: 420\n          secretName: amq-secrets\n\
    ---\n\n\n\n\n\n\n\n\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n\
    \  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/backend-protocol:\
    \ https\n    nginx.ingress.kubernetes.io/secure-backends: \"true\"\n    nginx.org/ssl-services:\
    \ openunison\n    nginx.ingress.kubernetes.io/affinity: cookie\n    nginx.ingress.kubernetes.io/session-cookie-name:\
    \ INGRESSCOOKIE\n    nginx.ingress.kubernetes.io/session-cookie-hash: sha1\n \
    \ name: openunison-ingress\n  namespace: openunison\nspec:\n  rules:\n  - host:\
    \ #[OU_HOST]\n    http:\n      paths:\n      - backend:\n          serviceName:\
    \ openunison\n          servicePort: 443\n        path: /\n  - host: #[K8S_DASHBOARD_HOST]\n\
    \    http:\n      paths:\n      - backend:\n          serviceName: openunison\n\
    \          servicePort: 443\n        path: /\n  tls:\n  - hosts:\n    - #[OU_HOST]\n\
    \    - #[K8S_DASHBOARD_HOST]\n    secretName: ou-tls-certificate\nstatus:\n  loadBalancer:\
    \ {}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: openunison\n\
    \  name: openunison\n  namespace: openunison\nspec:\n  ports:\n  - name: openunison-secure\n\
    \    port: 443\n    protocol: TCP\n    targetPort: 8443\n  - name: openunison-insecure\n\
    \    port: 80\n    protocol: TCP\n    targetPort: 8080\n  selector:\n    app:\
    \ openunison\n  sessionAffinity: ClientIP\n  sessionAffinityConfig:\n    clientIP:\n\
    \      timeoutSeconds: 10800\n  type: ClusterIP\nstatus:\n  loadBalancer: {}\n\
    ---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n\
    \    app: openunison\n  name: openunison\n  namespace: openunison\nspec:\n  progressDeadlineSeconds:\
    \ 600\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n\
    \      app: openunison\n  strategy:\n    rollingUpdate:\n      maxSurge: 25%\n\
    \      maxUnavailable: 25%\n    type: RollingUpdate\n  template:\n    metadata:\n\
    \      creationTimestamp: null\n      labels:\n        app: openunison\n    spec:\n\
    \      containers:\n      - env:\n        - name: JAVA_OPTS\n          value:\
    \ -Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom\n         \
    \   -DunisonEnvironmentFile=/etc/openunison/ou.env\n        - name: fortriggerupdates\n\
    \          value: changeme\n        - name: MYVD_CONFIG_PATH\n          value:\
    \ WEB-INF/myvd.conf\n        image: docker.io/tremolosecurity/openunison-k8s-activedirectory\n\
    \        imagePullPolicy: Always\n        livenessProbe:\n          exec:\n  \
    \          command:\n            - /usr/local/openunison/bin/check_alive.py\n\
    \          failureThreshold: 10\n          initialDelaySeconds: 120\n        \
    \  periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds:\
    \ 10\n        name: openunison\n        ports:\n        - containerPort: 8080\n\
    \          name: http\n          protocol: TCP\n        - containerPort: 8443\n\
    \          name: https\n          protocol: TCP\n        readinessProbe:\n   \
    \       exec:\n            command:\n            - /usr/local/openunison/bin/check_alive.py\n\
    \            - https://127.0.0.1:8443/auth/idp/k8sIdp/.well-known/openid-configuration\n\
    \            - issuer\n          failureThreshold: 3\n          initialDelaySeconds:\
    \ 30\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds:\
    \ 10\n        resources: {}\n        terminationMessagePath: /dev/termination-log\n\
    \        terminationMessagePolicy: File\n        volumeMounts:\n        - mountPath:\
    \ /etc/openunison\n          name: secret-volume\n          readOnly: true\n \
    \     dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      terminationGracePeriodSeconds:\
    \ 30\n      serviceAccount: openunison\n      serviceAccountName: openunison\n\
    \      volumes:\n      - name: secret-volume\n        secret:\n          defaultMode:\
    \ 420\n          secretName: openunison-secrets"
  quartz.sql: "# By: Ron Cordell - roncordell\n#  I didn't see this anywhere, so I\
    \ thought I'd post it here. This is the script from Quartz to create the tables\
    \ in a MySQL database, modified to use INNODB instead of MYISAM.\n\n\n# make sure\
    \ you have UTF-8 collaction for best .NET interoperability\n# CREATE DATABASE\
    \ quartznet CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\n\nDROP TABLE IF\
    \ EXISTS QRTZ_FIRED_TRIGGERS;\nDROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;\n\
    DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;\nDROP TABLE IF EXISTS QRTZ_LOCKS;\n\
    DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;\nDROP TABLE IF EXISTS QRTZ_SIMPROP_TRIGGERS;\n\
    DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;\nDROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;\n\
    DROP TABLE IF EXISTS QRTZ_TRIGGERS;\nDROP TABLE IF EXISTS QRTZ_JOB_DETAILS;\n\
    DROP TABLE IF EXISTS QRTZ_CALENDARS;\n\nCREATE TABLE QRTZ_JOB_DETAILS(\nSCHED_NAME\
    \ VARCHAR(120) NOT NULL,\nJOB_NAME VARCHAR(200) NOT NULL,\nJOB_GROUP VARCHAR(200)\
    \ NOT NULL,\nDESCRIPTION VARCHAR(250) NULL,\nJOB_CLASS_NAME VARCHAR(250) NOT NULL,\n\
    IS_DURABLE BOOLEAN NOT NULL,\nIS_NONCONCURRENT BOOLEAN NOT NULL,\nIS_UPDATE_DATA\
    \ BOOLEAN NOT NULL,\nREQUESTS_RECOVERY BOOLEAN NOT NULL,\nJOB_DATA BLOB NULL,\n\
    PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP))\nENGINE=InnoDB;\n\nCREATE TABLE QRTZ_TRIGGERS\
    \ (\nSCHED_NAME VARCHAR(120) NOT NULL,\nTRIGGER_NAME VARCHAR(200) NOT NULL,\n\
    TRIGGER_GROUP VARCHAR(200) NOT NULL,\nJOB_NAME VARCHAR(200) NOT NULL,\nJOB_GROUP\
    \ VARCHAR(200) NOT NULL,\nDESCRIPTION VARCHAR(250) NULL,\nNEXT_FIRE_TIME BIGINT(19)\
    \ NULL,\nPREV_FIRE_TIME BIGINT(19) NULL,\nPRIORITY INTEGER NULL,\nTRIGGER_STATE\
    \ VARCHAR(16) NOT NULL,\nTRIGGER_TYPE VARCHAR(8) NOT NULL,\nSTART_TIME BIGINT(19)\
    \ NOT NULL,\nEND_TIME BIGINT(19) NULL,\nCALENDAR_NAME VARCHAR(200) NULL,\nMISFIRE_INSTR\
    \ SMALLINT(2) NULL,\nJOB_DATA BLOB NULL,\nPRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),\n\
    FOREIGN KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)\nREFERENCES QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP))\n\
    ENGINE=InnoDB;\n\nCREATE TABLE QRTZ_SIMPLE_TRIGGERS (\nSCHED_NAME VARCHAR(120)\
    \ NOT NULL,\nTRIGGER_NAME VARCHAR(200) NOT NULL,\nTRIGGER_GROUP VARCHAR(200) NOT\
    \ NULL,\nREPEAT_COUNT BIGINT(7) NOT NULL,\nREPEAT_INTERVAL BIGINT(12) NOT NULL,\n\
    TIMES_TRIGGERED BIGINT(10) NOT NULL,\nPRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),\n\
    FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)\nREFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))\n\
    ENGINE=InnoDB;\n\nCREATE TABLE QRTZ_CRON_TRIGGERS (\nSCHED_NAME VARCHAR(120) NOT\
    \ NULL,\nTRIGGER_NAME VARCHAR(200) NOT NULL,\nTRIGGER_GROUP VARCHAR(200) NOT NULL,\n\
    CRON_EXPRESSION VARCHAR(120) NOT NULL,\nTIME_ZONE_ID VARCHAR(80),\nPRIMARY KEY\
    \ (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),\nFOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)\n\
    REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))\nENGINE=InnoDB;\n\
    \nCREATE TABLE QRTZ_SIMPROP_TRIGGERS\n  (          \n    SCHED_NAME VARCHAR(120)\
    \ NOT NULL,\n    TRIGGER_NAME VARCHAR(200) NOT NULL,\n    TRIGGER_GROUP VARCHAR(200)\
    \ NOT NULL,\n    STR_PROP_1 VARCHAR(512) NULL,\n    STR_PROP_2 VARCHAR(512) NULL,\n\
    \    STR_PROP_3 VARCHAR(512) NULL,\n    INT_PROP_1 INT NULL,\n    INT_PROP_2 INT\
    \ NULL,\n    LONG_PROP_1 BIGINT NULL,\n    LONG_PROP_2 BIGINT NULL,\n    DEC_PROP_1\
    \ NUMERIC(13,4) NULL,\n    DEC_PROP_2 NUMERIC(13,4) NULL,\n    BOOL_PROP_1 BOOLEAN\
    \ NULL,\n    BOOL_PROP_2 BOOLEAN NULL,\n    TIME_ZONE_ID VARCHAR(80) NULL,\n \
    \   PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),\n    FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)\
    \ \n    REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))\nENGINE=InnoDB;\n\
    \nCREATE TABLE QRTZ_BLOB_TRIGGERS (\nSCHED_NAME VARCHAR(120) NOT NULL,\nTRIGGER_NAME\
    \ VARCHAR(200) NOT NULL,\nTRIGGER_GROUP VARCHAR(200) NOT NULL,\nBLOB_DATA BLOB\
    \ NULL,\nPRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),\nINDEX (SCHED_NAME,TRIGGER_NAME,\
    \ TRIGGER_GROUP),\nFOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)\nREFERENCES\
    \ QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))\nENGINE=InnoDB;\n\nCREATE\
    \ TABLE QRTZ_CALENDARS (\nSCHED_NAME VARCHAR(120) NOT NULL,\nCALENDAR_NAME VARCHAR(200)\
    \ NOT NULL,\nCALENDAR BLOB NOT NULL,\nPRIMARY KEY (SCHED_NAME,CALENDAR_NAME))\n\
    ENGINE=InnoDB;\n\nCREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS (\nSCHED_NAME VARCHAR(120)\
    \ NOT NULL,\nTRIGGER_GROUP VARCHAR(200) NOT NULL,\nPRIMARY KEY (SCHED_NAME,TRIGGER_GROUP))\n\
    ENGINE=InnoDB;\n\nCREATE TABLE QRTZ_FIRED_TRIGGERS (\nSCHED_NAME VARCHAR(120)\
    \ NOT NULL,\nENTRY_ID VARCHAR(140) NOT NULL,\nTRIGGER_NAME VARCHAR(200) NOT NULL,\n\
    TRIGGER_GROUP VARCHAR(200) NOT NULL,\nINSTANCE_NAME VARCHAR(200) NOT NULL,\nFIRED_TIME\
    \ BIGINT(19) NOT NULL,\nSCHED_TIME BIGINT(19) NOT NULL,\nPRIORITY INTEGER NOT\
    \ NULL,\nSTATE VARCHAR(16) NOT NULL,\nJOB_NAME VARCHAR(200) NULL,\nJOB_GROUP VARCHAR(200)\
    \ NULL,\nIS_NONCONCURRENT BOOLEAN NULL,\nREQUESTS_RECOVERY BOOLEAN NULL,\nPRIMARY\
    \ KEY (SCHED_NAME,ENTRY_ID))\nENGINE=InnoDB;\n\nCREATE TABLE QRTZ_SCHEDULER_STATE\
    \ (\nSCHED_NAME VARCHAR(120) NOT NULL,\nINSTANCE_NAME VARCHAR(200) NOT NULL,\n\
    LAST_CHECKIN_TIME BIGINT(19) NOT NULL,\nCHECKIN_INTERVAL BIGINT(19) NOT NULL,\n\
    PRIMARY KEY (SCHED_NAME,INSTANCE_NAME))\nENGINE=InnoDB;\n\nCREATE TABLE QRTZ_LOCKS\
    \ (\nSCHED_NAME VARCHAR(120) NOT NULL,\nLOCK_NAME VARCHAR(40) NOT NULL,\nPRIMARY\
    \ KEY (SCHED_NAME,LOCK_NAME))\nENGINE=InnoDB;\n\nCREATE INDEX IDX_QRTZ_J_REQ_RECOVERY\
    \ ON QRTZ_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);\nCREATE INDEX IDX_QRTZ_J_GRP\
    \ ON QRTZ_JOB_DETAILS(SCHED_NAME,JOB_GROUP);\n\nCREATE INDEX IDX_QRTZ_T_J ON QRTZ_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);\n\
    CREATE INDEX IDX_QRTZ_T_JG ON QRTZ_TRIGGERS(SCHED_NAME,JOB_GROUP);\nCREATE INDEX\
    \ IDX_QRTZ_T_C ON QRTZ_TRIGGERS(SCHED_NAME,CALENDAR_NAME);\nCREATE INDEX IDX_QRTZ_T_G\
    \ ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);\nCREATE INDEX IDX_QRTZ_T_STATE ON\
    \ QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE);\nCREATE INDEX IDX_QRTZ_T_N_STATE ON\
    \ QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);\nCREATE\
    \ INDEX IDX_QRTZ_T_N_G_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);\n\
    CREATE INDEX IDX_QRTZ_T_NEXT_FIRE_TIME ON QRTZ_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);\n\
    CREATE INDEX IDX_QRTZ_T_NFT_ST ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);\n\
    CREATE INDEX IDX_QRTZ_T_NFT_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);\n\
    CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);\n\
    CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE_GRP ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);\n\
    \nCREATE INDEX IDX_QRTZ_FT_TRIG_INST_NAME ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);\n\
    CREATE INDEX IDX_QRTZ_FT_INST_JOB_REQ_RCVRY ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);\n\
    CREATE INDEX IDX_QRTZ_FT_J_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);\n\
    CREATE INDEX IDX_QRTZ_FT_JG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);\nCREATE\
    \ INDEX IDX_QRTZ_FT_T_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);\n\
    CREATE INDEX IDX_QRTZ_FT_TG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);\n\
    \ncommit; \n"
kind: ConfigMap
metadata:
  name: deployment-scripts
  namespace: openunison-deploy
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: artifact-deployment
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: ServiceAccount
  namespace: openunison-deploy
  name: default
---
apiVersion: batch/v1
kind: Job
metadata:
  name: artifact-deployment
  namespace: openunison-deploy
spec:
  template:
    spec:
      containers:
      - name: artifact-deployment
        image: docker.io/tremolosecurity/kubernetes-artifact-deployment:latest
        command: ["java", "-jar", "/usr/local/artifactdeploy/artifact-deploy.jar",  "-extraCertsPath","/etc/extracerts","-installScriptURL", "file:///etc/input-maps/deploy.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/secrets/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/openunison.yaml"]
        volumeMounts:
          - name: secrets-dir
            mountPath: "/etc/secrets"
            readOnly: true
          - name: extra-certs-dir
            mountPath: "/etc/extracerts"
            readOnly: true
          - name: input-maps
            mountPath: "/etc/input-maps"
            readOnly: true 
      restartPolicy: Never
      volumes:
        - name : secrets-dir
          secret:
            secretName: input
        - name : extra-certs-dir
          configMap:
            name: extracerts
        - name: input-maps
          configMap:
            name: deployment-scripts
  backoffLimit: 1